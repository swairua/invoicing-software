<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Quotation Items Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; white-space: pre-wrap; }
        button { padding: 8px 16px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a8b; }
        .error { background: #ffe6e6; border-left: 4px solid #ff0000; }
        .success { background: #e6ffe6; border-left: 4px solid #00ff00; }
    </style>
</head>
<body>
    <h1>Add Quotation Items Test</h1>
    
    <div class="section">
        <h3>Step 1: Get Quotations</h3>
        <button onclick="getQuotations()">Get Quotations</button>
        <div id="quotations-result" class="result"></div>
    </div>

    <div class="section">
        <h3>Step 2: Get Products</h3>
        <button onclick="getProducts()">Get Products</button>
        <div id="products-result" class="result"></div>
    </div>

    <div class="section">
        <h3>Step 3: Add Items to First Quotation</h3>
        <button onclick="addItemsToQuotation()">Add Items to Quotation</button>
        <div id="add-items-result" class="result"></div>
    </div>

    <div class="section">
        <h3>Step 4: Check Quotation with Items</h3>
        <button onclick="checkQuotationWithItems()">Check Quotation Details</button>
        <div id="check-result" class="result"></div>
    </div>

    <script>
        const API_BASE = '/api';
        const COMPANY_ID = '00000000-0000-0000-0000-000000000001';
        
        let currentQuotations = [];
        let currentProducts = [];

        async function apiCall(endpoint, options = {}) {
            const url = API_BASE + endpoint;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    'x-company-id': COMPANY_ID,
                    ...options.headers
                },
                ...options
            };
            
            console.log('API Call:', url, config);
            const response = await fetch(url, config);
            const result = await response.json();
            console.log('API Result:', result);
            return result;
        }

        async function getQuotations() {
            try {
                const result = await apiCall('/quotations');
                currentQuotations = result.data || [];
                document.getElementById('quotations-result').textContent = 
                    `Found ${currentQuotations.length} quotations:\n` + JSON.stringify(result, null, 2);
                document.getElementById('quotations-result').className = 'result success';
            } catch (error) {
                document.getElementById('quotations-result').textContent = 'Error: ' + error.message;
                document.getElementById('quotations-result').className = 'result error';
            }
        }

        async function getProducts() {
            try {
                const result = await apiCall('/products');
                currentProducts = result.data || [];
                document.getElementById('products-result').textContent = 
                    `Found ${currentProducts.length} products:\n` + JSON.stringify(result.data.slice(0, 3), null, 2);
                document.getElementById('products-result').className = 'result success';
            } catch (error) {
                document.getElementById('products-result').textContent = 'Error: ' + error.message;
                document.getElementById('products-result').className = 'result error';
            }
        }

        async function addItemsToQuotation() {
            try {
                if (currentQuotations.length === 0) {
                    throw new Error('No quotations available. Run Step 1 first.');
                }
                if (currentProducts.length === 0) {
                    throw new Error('No products available. Run Step 2 first.');
                }

                const firstQuotation = currentQuotations[0];
                const firstProduct = currentProducts[0];
                
                // Direct SQL execution through a custom endpoint
                const insertQuery = `
                    INSERT INTO quotation_items (
                        id, quotation_id, product_id, description, quantity, 
                        unit_price, discount_percentage, discount_amount, 
                        tax_rate, tax_amount, line_total, sort_order
                    ) VALUES (UUID(), ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                `;
                
                const quantity = 2;
                const unitPrice = parseFloat(firstProduct.sellingPrice) || 100;
                const discountPercentage = 0;
                const discountAmount = 0;
                const vatRate = 16;
                const subtotal = quantity * unitPrice;
                const vatAmount = (subtotal * vatRate) / 100;
                const lineTotal = subtotal + vatAmount;

                // Use the database endpoint to execute raw SQL
                const queryResult = await apiCall('/database/execute', {
                    method: 'POST',
                    body: JSON.stringify({
                        query: insertQuery,
                        params: [
                            firstQuotation.id,
                            firstProduct.id,
                            firstProduct.name,
                            quantity,
                            unitPrice,
                            discountPercentage,
                            discountAmount,
                            vatRate,
                            vatAmount,
                            lineTotal,
                            1
                        ]
                    })
                });

                // Update quotation totals
                const updateQuery = `
                    UPDATE quotations 
                    SET subtotal = ?, tax_amount = ?, total_amount = ?
                    WHERE id = ?
                `;
                
                await apiCall('/database/execute', {
                    method: 'POST',
                    body: JSON.stringify({
                        query: updateQuery,
                        params: [subtotal, vatAmount, lineTotal, firstQuotation.id]
                    })
                });

                document.getElementById('add-items-result').textContent = 
                    `Successfully added item to quotation ${firstQuotation.quote_number}:\n` +
                    `${quantity}x ${firstProduct.name} @ ${unitPrice} = ${lineTotal}\n` +
                    JSON.stringify(queryResult, null, 2);
                document.getElementById('add-items-result').className = 'result success';
                
            } catch (error) {
                document.getElementById('add-items-result').textContent = 'Error: ' + error.message;
                document.getElementById('add-items-result').className = 'result error';
            }
        }

        async function checkQuotationWithItems() {
            try {
                if (currentQuotations.length === 0) {
                    throw new Error('No quotations available. Run Step 1 first.');
                }

                const firstQuotation = currentQuotations[0];
                const result = await apiCall(`/quotations/${firstQuotation.id}`);
                
                document.getElementById('check-result').textContent = 
                    `Quotation Details:\n` + JSON.stringify(result, null, 2);
                document.getElementById('check-result').className = 'result success';
                
            } catch (error) {
                document.getElementById('check-result').textContent = 'Error: ' + error.message;
                document.getElementById('check-result').className = 'result error';
            }
        }

        // Auto-load data on page load
        window.onload = function() {
            getQuotations();
            getProducts();
        };
    </script>
</body>
</html>
