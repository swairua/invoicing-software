<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Proforma Table</title>
</head>
<body>
    <h1>Create Proforma Tables</h1>
    <button onclick="createProformaTable()">Create Proforma Table</button>
    <div id="output"></div>

    <script>
        async function createProformaTable() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>Creating proforma_invoices table...</p>';

            try {
                // Create main proforma_invoices table
                const createTableResponse = await fetch('/api/database/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-company-id': '00000000-0000-0000-0000-000000000001'
                    },
                    body: JSON.stringify({
                        query: `CREATE TABLE IF NOT EXISTS proforma_invoices (
                            id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
                            company_id VARCHAR(36) NOT NULL,
                            customer_id VARCHAR(36) NOT NULL,
                            proforma_number VARCHAR(50) NOT NULL,
                            status ENUM('draft', 'sent', 'expired', 'converted') DEFAULT 'draft',
                            issue_date DATE NOT NULL,
                            valid_until DATE NOT NULL,
                            subtotal DECIMAL(15,2) DEFAULT 0,
                            tax_amount DECIMAL(15,2) DEFAULT 0,
                            total_amount DECIMAL(15,2) DEFAULT 0,
                            notes TEXT,
                            terms_and_conditions TEXT,
                            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                            INDEX idx_company_customer (company_id, customer_id),
                            INDEX idx_proforma_number (proforma_number),
                            INDEX idx_status (status)
                        )`
                    })
                });

                const tableResult = await createTableResponse.json();
                if (!tableResult.success) {
                    throw new Error('Failed to create proforma_invoices table: ' + tableResult.error);
                }

                output.innerHTML += '<p>‚úÖ proforma_invoices table created successfully</p>';

                // Create proforma_invoice_items table
                const createItemsResponse = await fetch('/api/database/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-company-id': '00000000-0000-0000-0000-000000000001'
                    },
                    body: JSON.stringify({
                        query: `CREATE TABLE IF NOT EXISTS proforma_invoice_items (
                            id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
                            proforma_id VARCHAR(36) NOT NULL,
                            product_id VARCHAR(36) NOT NULL,
                            quantity DECIMAL(10,2) NOT NULL,
                            unit_price DECIMAL(15,2) NOT NULL,
                            discount_percentage DECIMAL(5,2) DEFAULT 0,
                            line_total DECIMAL(15,2) NOT NULL,
                            tax_rate DECIMAL(5,2) DEFAULT 0,
                            tax_amount DECIMAL(15,2) DEFAULT 0,
                            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                            INDEX idx_proforma (proforma_id),
                            INDEX idx_product (product_id)
                        )`
                    })
                });

                const itemsResult = await createItemsResponse.json();
                if (!itemsResult.success) {
                    throw new Error('Failed to create proforma_invoice_items table: ' + itemsResult.error);
                }

                output.innerHTML += '<p>‚úÖ proforma_invoice_items table created successfully</p>';

                // Insert sample data
                const insertSampleResponse = await fetch('/api/database/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-company-id': '00000000-0000-0000-0000-000000000001'
                    },
                    body: JSON.stringify({
                        query: `INSERT IGNORE INTO proforma_invoices (
                            id, company_id, customer_id, proforma_number, status, 
                            issue_date, valid_until, subtotal, tax_amount, total_amount, notes
                        ) VALUES 
                        (
                            'pf001-7c1a-11f0-a984-365070d15890',
                            '00000000-0000-0000-0000-000000000001',
                            (SELECT id FROM customers LIMIT 1),
                            'PF-2025-001',
                            'sent',
                            CURDATE(),
                            DATE_ADD(CURDATE(), INTERVAL 30 DAY),
                            85000.00,
                            13600.00,
                            98600.00,
                            'Standard medical supplies proforma invoice'
                        ),
                        (
                            'pf002-7c1a-11f0-a984-365070d15890',
                            '00000000-0000-0000-0000-000000000001',
                            (SELECT id FROM customers ORDER BY id LIMIT 1 OFFSET 1),
                            'PF-2025-002',
                            'draft',
                            CURDATE(),
                            DATE_ADD(CURDATE(), INTERVAL 15 DAY),
                            25000.00,
                            4000.00,
                            29000.00,
                            'Electronics equipment proforma'
                        )`
                    })
                });

                const sampleResult = await insertSampleResponse.json();
                if (!sampleResult.success) {
                    console.warn('Sample data insertion failed:', sampleResult.error);
                    output.innerHTML += '<p>‚ö†Ô∏è Sample data insertion failed, but tables created successfully</p>';
                } else {
                    output.innerHTML += '<p>‚úÖ Sample proforma data inserted</p>';
                }

                output.innerHTML += '<p>üéâ <strong>Proforma tables setup completed successfully!</strong></p>';
                output.innerHTML += '<p>You can now refresh the proforma page to see the data.</p>';

            } catch (error) {
                output.innerHTML += '<p style="color: red;">‚ùå Error: ' + error.message + '</p>';
                console.error('Error creating proforma table:', error);
            }
        }

        // Auto-run on page load
        window.addEventListener('load', createProformaTable);
    </script>
</body>
</html>
